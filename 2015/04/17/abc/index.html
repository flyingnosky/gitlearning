<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>cpio Filesystem | Still On The Road</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="How To Add Services Into cpio Filesystem To Make Cpu and Memory High Load
Sometimes some performances of D02 board should be tested under high cpu and memory load, so we can add some stress services i">
<meta property="og:type" content="article">
<meta property="og:title" content="cpio Filesystem">
<meta property="og:url" content="http://yoursite.com/2015/04/17/abc/">
<meta property="og:site_name" content="Still On The Road">
<meta property="og:description" content="How To Add Services Into cpio Filesystem To Make Cpu and Memory High Load
Sometimes some performances of D02 board should be tested under high cpu and memory load, so we can add some stress services i">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="cpio Filesystem">
<meta name="twitter:description" content="How To Add Services Into cpio Filesystem To Make Cpu and Memory High Load
Sometimes some performances of D02 board should be tested under high cpu and memory load, so we can add some stress services i">

  
    <link rel="alternative" href="/atom.xml" title="Still On The Road" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Still On The Road</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-abc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/04/17/abc/" class="article-date">
  <time datetime="2015-04-17T02:09:00.000Z" itemprop="datePublished">Apr 17 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Basic/">Basic</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      cpio Filesystem
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="How_To_Add_Services_Into_cpio_Filesystem_To_Make_Cpu_and_Memory_High_Load">How To Add Services Into cpio Filesystem To Make Cpu and Memory High Load</h2>
<p>Sometimes some performances of D02 board should be tested under high cpu and memory load, so we can add some stress services into filesystem to realize the requirements. In my case, we already have cpio filesystem hulk-hip05.cpio.gz and stress service will be added into cpio filesystem as following steps.<br><a id="more"></a></p>
<h3 id="(1)What_is_stress">(1)What is stress</h3>
<p>Stress is a simple workload generator for POSIX system. It imposes a configurable amount of CPU,memory, I/O, and disk stress on the system. We can download it from website:</p>
<pre><code>http:<span class="comment">//www.filewatcher.com/m/stress-1.0.1.tar.gz.203343-1.html</span>
</code></pre><h3 id="(2)Preparation">(2)Preparation</h3>
<p>a.Download 64bit cross compile toolchain and export the path<br>we can get this toolchain from the website:</p>
<pre><code><span class="label">http:</span>//releases.linaro<span class="preprocessor">.org</span>/<span class="number">14.09</span>/components/toolchain/binaries/gcc-linaro-aarch64-linux-gnu-<span class="number">4.9</span>-<span class="number">2014.09</span>_linux.tar.xz
</code></pre><p>b.Decompress cpio filesystem hulk-hip05.cpio.gz<br>The steps of decompression cpio filesystem hulk-hip05.cpio.gz are as follows:</p>
<pre><code>cd <span class="regexp">/path/</span>of<span class="regexp">/hulk-hip05/</span>
gunzip hulk-hip05.cpio.gz
cpio -idmv &lt; hulk-hip05.cpio.gz
</code></pre><p>After that we get fold named hulk-hip05 which includes files of cpio filesystem.And/path/of/hulk-hip05/ is the location path of hulk-hip05.<br><strong><em>Note:we must decompress and make cpio filesystem with ROOT user, or we will lost some services. Thisâ€™s important.</em></strong></p>
<h3 id="(3)How_to_compile_stress">(3)How to compile stress</h3>
<p>We can compile service stress as the following step:</p>
<pre><code>./configure <span class="variable">CC=</span>aarch64-linux-gnu-gcc  <span class="variable">--host=</span>arm64  <span class="variable">--prefix=</span>/path/of/hulk-hip05/usr/local
make 
make install
</code></pre><h3 id="(4)How_to_make_cpio_filesystem">(4)How to make cpio filesystem</h3>
<p>a.Run ###gen_initramfs_list.sh### to create filelist</p>
<pre><code><span class="input"><span class="prompt">./gen_initramfs_list.sh ./hulk-hip05/ &gt;</span> filelist</span>
</code></pre><p>Note:gen_initramfs_list.sh is the script that creates filelist.<br>b.Create gen_init_cpio tool through source code<br>gen_init_cpio is a tool that trasfer filelist into cpio filesystem.we can create this tool by building the source codes.</p>
<pre><code>gcc -o gen_init_cpio gen_init_cpio.<span class="built_in">c</span>
</code></pre><p>Note:source code gen_init_cpio.c are below.<br>c.Create cpio filesystem using gen_init_cpio</p>
<pre><code><span class="input"><span class="prompt">gen_init_cpio filelist &gt;</span> rootfs.cpio</span>
</code></pre><p>d.Compress cpio filesystem into cpio.gz filesystem  </p>
<pre><code><span class="title">gzip</span> rootfs.cpio
</code></pre><h3 id="script_of_gen_initramfs_list-sh:">script of gen_initramfs_list.sh:</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div></pre></td><td class="code"><pre><div class="line"><span class="shebang">#!/bin/sh</span></div><div class="line"><span class="comment"># Copyright (C) Martin Schlemmer &lt;azarah@nosferatu.za.org&gt;</span></div><div class="line"><span class="comment"># Copyright (C) 2006 Sam Ravnborg &lt;sam@ravnborg.org&gt;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Released under the terms of the GNU GPL</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Generate a cpio packed initramfs. It uses gen_init_cpio to generate</span></div><div class="line"><span class="comment"># the cpio archive, and then compresses it.</span></div><div class="line"><span class="comment"># The script may also be used to generate the inputfile used for gen_init_cpio</span></div><div class="line"><span class="comment"># This script assumes that gen_init_cpio is located in usr/ directory</span></div><div class="line"><span class="comment"># error out on errors</span></div><div class="line"><span class="keyword">set</span> <span class="operator">-e</span></div><div class="line"><span class="function"><span class="title">usage</span></span>() {</div><div class="line">cat &lt;&lt; EOF</div><div class="line">Usage:</div><div class="line"><span class="variable">$0</span> [-o &lt;file&gt;] [-u &lt;uid&gt;] [-g &lt;gid&gt;] {<span class="operator">-d</span> | &lt;cpio_<span class="built_in">source</span>&gt;} ...</div><div class="line">	-o &lt;file&gt;      Create compressed initramfs file named &lt;file&gt; using</div><div class="line">		       gen_init_cpio and compressor depending on the extension</div><div class="line">	-u &lt;uid&gt;       User ID to map to user ID <span class="number">0</span> (root).</div><div class="line">		       &lt;uid&gt; is only meaningful <span class="keyword">if</span> &lt;cpio_<span class="built_in">source</span>&gt; is a</div><div class="line">		       directory.  <span class="string">"squash"</span> forces all files to uid <span class="number">0</span>.</div><div class="line">	-g &lt;gid&gt;       Group ID to map to group ID <span class="number">0</span> (root).</div><div class="line">		       &lt;gid&gt; is only meaningful <span class="keyword">if</span> &lt;cpio_<span class="built_in">source</span>&gt; is a</div><div class="line">		       directory.  <span class="string">"squash"</span> forces all files to gid <span class="number">0</span>.</div><div class="line">	&lt;cpio_<span class="built_in">source</span>&gt;  File list or directory <span class="keyword">for</span> cpio archive.</div><div class="line">		       If &lt;cpio_<span class="built_in">source</span>&gt; is a .cpio file it will be used</div><div class="line">		       as direct input to initramfs.</div><div class="line">	<span class="operator">-d</span>             Output the default cpio list.</div><div class="line">All options except -o and <span class="operator">-l</span> may be repeated and are interpreted</div><div class="line">sequentially and immediately.  -u and -g states are preserved across</div><div class="line">&lt;cpio_<span class="built_in">source</span>&gt; options so an explicit <span class="string">"-u 0 -g 0"</span> is required</div><div class="line">to reset the root/group mapping.</div><div class="line">EOF</div><div class="line">}</div><div class="line"><span class="comment"># awk style field access</span></div><div class="line"><span class="comment"># $1 - field number; rest is argument string</span></div><div class="line"><span class="function"><span class="title">field</span></span>() {</div><div class="line">	shift <span class="variable">$1</span> ; <span class="built_in">echo</span> <span class="variable">$1</span></div><div class="line">}</div><div class="line"><span class="function"><span class="title">list_default_initramfs</span></span>() {</div><div class="line">	<span class="comment"># echo usr/kinit/kinit</span></div><div class="line">	:</div><div class="line">}</div><div class="line"><span class="function"><span class="title">default_initramfs</span></span>() {</div><div class="line">	cat &lt;&lt;-EOF &gt;&gt; <span class="variable">${output}</span></div><div class="line">		<span class="comment"># This is a very simple, default initramfs</span></div><div class="line"></div><div class="line">		dir /dev <span class="number">0755</span> <span class="number">0</span> <span class="number">0</span></div><div class="line">		nod /dev/console <span class="number">0600</span> <span class="number">0</span> <span class="number">0</span> c <span class="number">5</span> <span class="number">1</span></div><div class="line">		dir /root <span class="number">0700</span> <span class="number">0</span> <span class="number">0</span></div><div class="line">		<span class="comment"># file /kinit usr/kinit/kinit 0755 0 0</span></div><div class="line">		<span class="comment"># slink /init kinit 0755 0 0</span></div><div class="line">	EOF</div><div class="line">}</div><div class="line"><span class="function"><span class="title">filetype</span></span>() {</div><div class="line">	local argv1=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">	<span class="comment"># symlink test must come before file test</span></div><div class="line">	<span class="keyword">if</span> [ -L <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"slink"</span></div><div class="line">	<span class="keyword">elif</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"file"</span></div><div class="line">	<span class="keyword">elif</span> [ <span class="operator">-d</span> <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"dir"</span></div><div class="line">	<span class="keyword">elif</span> [ -b <span class="string">"<span class="variable">${argv1}</span>"</span> -o -c <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"nod"</span></div><div class="line">	<span class="keyword">elif</span> [ -p <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"pipe"</span></div><div class="line">	<span class="keyword">elif</span> [ -S <span class="string">"<span class="variable">${argv1}</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"sock"</span></div><div class="line">	<span class="keyword">else</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"invalid"</span></div><div class="line">	<span class="keyword">fi</span></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span></div><div class="line">}</div><div class="line"><span class="function"><span class="title">list_print_mtime</span></span>() {</div><div class="line">	:</div><div class="line">}</div><div class="line"><span class="function"><span class="title">print_mtime</span></span>() {</div><div class="line">	local my_mtime=<span class="string">"0"</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> [ <span class="operator">-e</span> <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		my_mtime=$(find <span class="string">"<span class="variable">$1</span>"</span> -printf <span class="string">"%T@\n"</span> | sort -r | head -n <span class="number">1</span>)</div><div class="line">	<span class="keyword">fi</span></div><div class="line"></div><div class="line">	<span class="built_in">echo</span> <span class="string">"# Last modified: <span class="variable">${my_mtime}</span>"</span> &gt;&gt; <span class="variable">${output}</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">""</span> &gt;&gt; <span class="variable">${output}</span></div><div class="line">}</div><div class="line"><span class="function"><span class="title">list_parse</span></span>() {</div><div class="line">	[ ! -L <span class="string">"<span class="variable">$1</span>"</span> ] && <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span> \\"</span> || :</div><div class="line">}</div><div class="line"><span class="comment"># for each file print a line in following format</span></div><div class="line"><span class="comment"># &lt;filetype&gt; &lt;name&gt; &lt;path to file&gt; &lt;octal mode&gt; &lt;uid&gt; &lt;gid&gt;</span></div><div class="line"><span class="comment"># for links, devices etc the format differs. See gen_init_cpio for details</span></div><div class="line"><span class="function"><span class="title">parse</span></span>() {</div><div class="line">	local location=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">	local name=<span class="string">"/<span class="variable">${location#${srcdir}</span>}"</span></div><div class="line">	<span class="comment"># change '//' into '/'</span></div><div class="line">	name=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$name</span>"</span> | sed <span class="operator">-e</span> <span class="string">'s://*:/:g'</span>)</div><div class="line">	local mode=<span class="string">"<span class="variable">$2</span>"</span></div><div class="line">	local uid=<span class="string">"<span class="variable">$3</span>"</span></div><div class="line">	local gid=<span class="string">"<span class="variable">$4</span>"</span></div><div class="line">	local ftype=$(filetype <span class="string">"<span class="variable">${location}</span>"</span>)</div><div class="line">	<span class="comment"># remap uid/gid to 0 if necessary</span></div><div class="line">	[ <span class="string">"<span class="variable">$root_uid</span>"</span> = <span class="string">"squash"</span> ] && uid=<span class="number">0</span> || [ <span class="string">"<span class="variable">$uid</span>"</span> <span class="operator">-eq</span> <span class="string">"<span class="variable">$root_uid</span>"</span> ] && uid=<span class="number">0</span></div><div class="line">	[ <span class="string">"<span class="variable">$root_gid</span>"</span> = <span class="string">"squash"</span> ] && gid=<span class="number">0</span> || [ <span class="string">"<span class="variable">$gid</span>"</span> <span class="operator">-eq</span> <span class="string">"<span class="variable">$root_gid</span>"</span> ] && gid=<span class="number">0</span></div><div class="line">	local str=<span class="string">"<span class="variable">${mode}</span> <span class="variable">${uid}</span> <span class="variable">${gid}</span>"</span></div><div class="line">	[ <span class="string">"<span class="variable">${ftype}</span>"</span> = <span class="string">"invalid"</span> ] && <span class="keyword">return</span> <span class="number">0</span></div><div class="line">	[ <span class="string">"<span class="variable">${location}</span>"</span> = <span class="string">"<span class="variable">${srcdir}</span>"</span> ] && <span class="keyword">return</span> <span class="number">0</span></div><div class="line">	<span class="keyword">case</span> <span class="string">"<span class="variable">${ftype}</span>"</span> <span class="keyword">in</span></div><div class="line">		<span class="string">"file"</span>)</div><div class="line">			str=<span class="string">"<span class="variable">${ftype}</span> <span class="variable">${name}</span> <span class="variable">${location}</span> <span class="variable">${str}</span>"</span></div><div class="line">			;;</div><div class="line">		<span class="string">"nod"</span>)</div><div class="line">			local dev=`LC_ALL=C ls <span class="operator">-l</span> <span class="string">"<span class="variable">${location}</span>"</span>`</div><div class="line">			local maj=`field <span class="number">5</span> <span class="variable">${dev}</span>`</div><div class="line">			local min=`field <span class="number">6</span> <span class="variable">${dev}</span>`</div><div class="line">			maj=<span class="variable">${maj%,}</span></div><div class="line">			[ -b <span class="string">"<span class="variable">${location}</span>"</span> ] && dev=<span class="string">"b"</span> || dev=<span class="string">"c"</span></div><div class="line">			str=<span class="string">"<span class="variable">${ftype}</span> <span class="variable">${name}</span> <span class="variable">${str}</span> <span class="variable">${dev}</span> <span class="variable">${maj}</span> <span class="variable">${min}</span>"</span></div><div class="line">			;;</div><div class="line">		<span class="string">"slink"</span>)</div><div class="line">			local target=`readlink <span class="string">"<span class="variable">${location}</span>"</span>`</div><div class="line">			str=<span class="string">"<span class="variable">${ftype}</span> <span class="variable">${name}</span> <span class="variable">${target}</span> <span class="variable">${str}</span>"</span></div><div class="line">			;;</div><div class="line">		*)</div><div class="line">			str=<span class="string">"<span class="variable">${ftype}</span> <span class="variable">${name}</span> <span class="variable">${str}</span>"</span></div><div class="line">			;;</div><div class="line">	<span class="keyword">esac</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"<span class="variable">${str}</span>"</span> &gt;&gt; <span class="variable">${output}</span></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span></div><div class="line">}</div><div class="line"><span class="function"><span class="title">unknown_option</span></span>() {</div><div class="line">	<span class="built_in">printf</span> <span class="string">"ERROR: unknown option \"<span class="variable">$arg</span>\"\n"</span> &gt;&<span class="number">2</span></div><div class="line">	<span class="built_in">printf</span> <span class="string">"If the filename validly begins with '-', "</span> &gt;&<span class="number">2</span></div><div class="line">	<span class="built_in">printf</span> <span class="string">"then it must be prefixed\n"</span> &gt;&<span class="number">2</span></div><div class="line">	<span class="built_in">printf</span> <span class="string">"by './' so that it won't be interpreted as an option."</span> &gt;&<span class="number">2</span></div><div class="line">	<span class="built_in">printf</span> <span class="string">"\n"</span> &gt;&<span class="number">2</span></div><div class="line">	usage &gt;&<span class="number">2</span></div><div class="line">	<span class="keyword">exit</span> <span class="number">1</span></div><div class="line">}</div><div class="line"><span class="function"><span class="title">list_header</span></span>() {</div><div class="line">	:</div><div class="line">}</div><div class="line"><span class="function"><span class="title">header</span></span>() {</div><div class="line">	<span class="built_in">printf</span> <span class="string">"\n#####################\n# <span class="variable">$1</span>\n"</span> &gt;&gt; <span class="variable">${output}</span></div><div class="line">}</div><div class="line"><span class="comment"># process one directory (incl sub-directories)</span></div><div class="line"><span class="function"><span class="title">dir_filelist</span></span>() {</div><div class="line">	<span class="variable">${dep_list}</span>header <span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">	srcdir=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | sed <span class="operator">-e</span> <span class="string">'s://*:/:g'</span>)</div><div class="line">	dirlist=$(find <span class="string">"<span class="variable">${srcdir}</span>"</span> -printf <span class="string">"%p %m %U %G\n"</span>)</div><div class="line"></div><div class="line">	<span class="comment"># If $dirlist is only one line, then the directory is empty</span></div><div class="line">	<span class="keyword">if</span> [  <span class="string">"<span class="variable">$(echo "${dirlist}" | wc -l)</span>"</span> <span class="operator">-gt</span> <span class="number">1</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="variable">${dep_list}</span>print_mtime <span class="string">"<span class="variable">$1</span>"</span></div><div class="line"></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">${dirlist}</span>"</span> | \</div><div class="line">		<span class="keyword">while</span> <span class="built_in">read</span> x; <span class="keyword">do</span></div><div class="line">			<span class="variable">${dep_list}</span>parse <span class="variable">${x}</span></div><div class="line">		<span class="keyword">done</span></div><div class="line">	<span class="keyword">fi</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># if only one file is specified and it is .cpio file then use it direct as fs</span></div><div class="line"><span class="comment"># if a directory is specified then add all files in given direcotry to fs</span></div><div class="line"><span class="comment"># if a regular file is specified assume it is in gen_initramfs format</span></div><div class="line"><span class="function"><span class="title">input_file</span></span>() {</div><div class="line">	<span class="built_in">source</span>=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">	<span class="keyword">if</span> [ <span class="operator">-f</span> <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		<span class="variable">${dep_list}</span>header <span class="string">"<span class="variable">$1</span>"</span></div><div class="line">		is_cpio=<span class="string">"<span class="variable">$(echo "$1" | sed 's/^.*\.cpio\(\..*\)\?/cpio/')</span>"</span></div><div class="line">		<span class="keyword">if</span> [ <span class="variable">$2</span> <span class="operator">-eq</span> <span class="number">0</span> <span class="operator">-a</span> <span class="variable">${is_cpio}</span> = <span class="string">"cpio"</span> ]; <span class="keyword">then</span></div><div class="line">			cpio_file=<span class="variable">$1</span></div><div class="line">			<span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> | grep -q <span class="string">'^.*\.cpio\..*'</span> && is_cpio_compressed=<span class="string">"compressed"</span></div><div class="line">			[ ! -z <span class="variable">${dep_list}</span> ] && <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span></div><div class="line">		<span class="keyword">fi</span></div><div class="line">		<span class="keyword">if</span> [ -z <span class="variable">${dep_list}</span> ]; <span class="keyword">then</span></div><div class="line">			print_mtime <span class="string">"<span class="variable">$1</span>"</span> &gt;&gt; <span class="variable">${output}</span></div><div class="line">			cat <span class="string">"<span class="variable">$1</span>"</span>         &gt;&gt; <span class="variable">${output}</span></div><div class="line">		<span class="keyword">else</span></div><div class="line">		        <span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span> \\"</span></div><div class="line">			cat <span class="string">"<span class="variable">$1</span>"</span> | <span class="keyword">while</span> <span class="built_in">read</span> <span class="built_in">type</span> dir file perm ; <span class="keyword">do</span></div><div class="line">				<span class="keyword">if</span> [ <span class="string">"<span class="variable">$type</span>"</span> = <span class="string">"file"</span> ]; <span class="keyword">then</span></div><div class="line">					<span class="built_in">echo</span> <span class="string">"<span class="variable">$file</span> \\"</span>;</div><div class="line">				<span class="keyword">fi</span></div><div class="line">			<span class="keyword">done</span></div><div class="line">		<span class="keyword">fi</span></div><div class="line">	<span class="keyword">elif</span> [ <span class="operator">-d</span> <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></div><div class="line">		dir_filelist <span class="string">"<span class="variable">$1</span>"</span></div><div class="line">	<span class="keyword">else</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"  <span class="variable">${prog}</span>: Cannot open '<span class="variable">$1</span>'"</span> &gt;&<span class="number">2</span></div><div class="line">		<span class="keyword">exit</span> <span class="number">1</span></div><div class="line">	<span class="keyword">fi</span></div><div class="line">}</div><div class="line"></div><div class="line">prog=<span class="variable">$0</span></div><div class="line">root_uid=<span class="number">0</span></div><div class="line">root_gid=<span class="number">0</span></div><div class="line">dep_list=</div><div class="line">cpio_file=</div><div class="line">cpio_list=</div><div class="line">output=<span class="string">"/dev/stdout"</span></div><div class="line">output_file=<span class="string">""</span></div><div class="line">is_cpio_compressed=</div><div class="line">compr=<span class="string">"gzip -n -9 -f"</span></div><div class="line"></div><div class="line">arg=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$arg</span>"</span> <span class="keyword">in</span></div><div class="line">	<span class="string">"-l"</span>)	<span class="comment"># files included in initramfs - used by kbuild</span></div><div class="line">		dep_list=<span class="string">"list_"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"deps_initramfs := <span class="variable">$0</span> \\"</span></div><div class="line">		shift</div><div class="line">		;;</div><div class="line">	<span class="string">"-o"</span>)	<span class="comment"># generate compressed cpio image named $1</span></div><div class="line">		shift</div><div class="line">		output_file=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">		cpio_list=<span class="string">"<span class="variable">$(mktemp ${TMPDIR:-/tmp}/cpiolist.XXXXXX)</span>"</span></div><div class="line">		output=<span class="variable">${cpio_list}</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.gz$"</span> && compr=<span class="string">"gzip -n -9 -f"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.bz2$"</span> && compr=<span class="string">"bzip2 -9 -f"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.lzma$"</span> && compr=<span class="string">"lzma -9 -f"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.xz$"</span> && \</div><div class="line">				compr=<span class="string">"xz --check=crc32 --lzma2=dict=1MiB"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.lzo$"</span> && compr=<span class="string">"lzop -9 -f"</span></div><div class="line">		<span class="built_in">echo</span> <span class="string">"<span class="variable">$output_file</span>"</span> | grep -q <span class="string">"\.cpio$"</span> && compr=<span class="string">"cat"</span></div><div class="line">		shift</div><div class="line">		;;</div><div class="line"><span class="keyword">esac</span></div><div class="line"><span class="keyword">while</span> [ <span class="variable">$#</span> <span class="operator">-gt</span> <span class="number">0</span> ]; <span class="keyword">do</span></div><div class="line">	arg=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">	shift</div><div class="line">	<span class="keyword">case</span> <span class="string">"<span class="variable">$arg</span>"</span> <span class="keyword">in</span></div><div class="line">		<span class="string">"-u"</span>)	<span class="comment"># map $1 to uid=0 (root)</span></div><div class="line">			root_uid=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">			shift</div><div class="line">			;;</div><div class="line">		<span class="string">"-g"</span>)	<span class="comment"># map $1 to gid=0 (root)</span></div><div class="line">			root_gid=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">			shift</div><div class="line">			;;</div><div class="line">		<span class="string">"-d"</span>)	<span class="comment"># display default initramfs list</span></div><div class="line">			default_list=<span class="string">"<span class="variable">$arg</span>"</span></div><div class="line">			<span class="variable">${dep_list}</span>default_initramfs</div><div class="line">			;;</div><div class="line">		<span class="string">"-h"</span>)</div><div class="line">			usage</div><div class="line">			<span class="keyword">exit</span> <span class="number">0</span></div><div class="line">			;;</div><div class="line">		*)</div><div class="line">			<span class="keyword">case</span> <span class="string">"<span class="variable">$arg</span>"</span> <span class="keyword">in</span></div><div class="line">				<span class="string">"-"</span>*)</div><div class="line">					unknown_option</div><div class="line">					;;</div><div class="line">				*)	<span class="comment"># input file/dir - process it</span></div><div class="line">					input_file <span class="string">"<span class="variable">$arg</span>"</span> <span class="string">"<span class="variable">$#</span>"</span></div><div class="line">					;;</div><div class="line">			<span class="keyword">esac</span></div><div class="line">			;;</div><div class="line">	<span class="keyword">esac</span></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="comment"># If output_file is set we will generate cpio archive and compress it</span></div><div class="line"><span class="comment"># we are careful to delete tmp files</span></div><div class="line"><span class="keyword">if</span> [ ! -z <span class="variable">${output_file}</span> ]; <span class="keyword">then</span></div><div class="line">	<span class="keyword">if</span> [ -z <span class="variable">${cpio_file}</span> ]; <span class="keyword">then</span></div><div class="line">		timestamp=</div><div class="line">		<span class="keyword">if</span> test -n <span class="string">"<span class="variable">$KBUILD_BUILD_TIMESTAMP</span>"</span>; <span class="keyword">then</span></div><div class="line">			timestamp=<span class="string">"<span class="variable">$(date -d"$KBUILD_BUILD_TIMESTAMP" +%s || :)</span>"</span></div><div class="line">			<span class="keyword">if</span> test -n <span class="string">"<span class="variable">$timestamp</span>"</span>; <span class="keyword">then</span></div><div class="line">				timestamp=<span class="string">"-t <span class="variable">$timestamp</span>"</span></div><div class="line">			<span class="keyword">fi</span></div><div class="line">		<span class="keyword">fi</span></div><div class="line">		cpio_tfile=<span class="string">"<span class="variable">$(mktemp ${TMPDIR:-/tmp}/cpiofile.XXXXXX)</span>"</span></div><div class="line">		usr/gen_init_cpio <span class="variable">$timestamp</span> <span class="variable">${cpio_list}</span> &gt; <span class="variable">${cpio_tfile}</span></div><div class="line">	<span class="keyword">else</span></div><div class="line">		cpio_tfile=<span class="variable">${cpio_file}</span></div><div class="line">	<span class="keyword">fi</span></div><div class="line">	rm <span class="variable">${cpio_list}</span></div><div class="line">	<span class="keyword">if</span> [ <span class="string">"<span class="variable">${is_cpio_compressed}</span>"</span> = <span class="string">"compressed"</span> ]; <span class="keyword">then</span></div><div class="line">		cat <span class="variable">${cpio_tfile}</span> &gt; <span class="variable">${output_file}</span></div><div class="line">	<span class="keyword">else</span></div><div class="line">		(cat <span class="variable">${cpio_tfile}</span> | <span class="variable">${compr}</span>  - &gt; <span class="variable">${output_file}</span>) \</div><div class="line">		|| (rm <span class="operator">-f</span> <span class="variable">${output_file}</span> ; <span class="literal">false</span>)</div><div class="line">	<span class="keyword">fi</span></div><div class="line">	[ -z <span class="variable">${cpio_file}</span> ] && rm <span class="variable">${cpio_tfile}</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">exit</span> <span class="number">0</span></div></pre></td></tr></table></figure>

<h3 id="source_code_of_gen_init_cpio-c:">source code of gen_init_cpio.c:</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div><div class="line">562</div><div class="line">563</div><div class="line">564</div><div class="line">565</div><div class="line">566</div><div class="line">567</div><div class="line">568</div><div class="line">569</div><div class="line">570</div><div class="line">571</div><div class="line">572</div><div class="line">573</div><div class="line">574</div><div class="line">575</div><div class="line">576</div><div class="line">577</div><div class="line">578</div><div class="line">579</div><div class="line">580</div><div class="line">581</div><div class="line">582</div><div class="line">583</div><div class="line">584</div><div class="line">585</div><div class="line">586</div><div class="line">587</div><div class="line">588</div><div class="line">589</div><div class="line">590</div><div class="line">591</div><div class="line">592</div><div class="line">593</div><div class="line">594</div><div class="line">595</div><div class="line">596</div><div class="line">597</div><div class="line">598</div><div class="line">599</div><div class="line">600</div><div class="line">601</div><div class="line">602</div><div class="line">603</div><div class="line">604</div><div class="line">605</div><div class="line">606</div><div class="line">607</div><div class="line">608</div><div class="line">609</div><div class="line">610</div><div class="line">611</div><div class="line">612</div><div class="line">613</div><div class="line">614</div><div class="line">615</div><div class="line">616</div><div class="line">617</div><div class="line">618</div><div class="line">619</div><div class="line">620</div><div class="line">621</div><div class="line">622</div><div class="line">623</div><div class="line">624</div><div class="line">625</div><div class="line">626</div><div class="line">627</div><div class="line">628</div><div class="line">629</div><div class="line">630</div></pre></td><td class="code"><pre><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/types.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/stat.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;string.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;unistd.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;time.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;fcntl.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;errno.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;ctype.h&gt;</span></div><div class="line"><span class="preprocessor">#<span class="keyword">include</span> &lt;limits.h&gt;</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Original work by Jeff Garzik</div><div class="line"> *</div><div class="line"> * External file lists, symlink, pipe and fifo support by Thayne Harbaugh</div><div class="line"> * Hard link support by Luciano Rocha</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> xstr(s) #s</span></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> str(s) xstr(s)</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> offset;</div><div class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> ino = <span class="number">721</span>;</div><div class="line"><span class="keyword">static</span> time_t default_mtime;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> file_handler {</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *type;</div><div class="line">	<span class="keyword">int</span> (*handler)(<span class="keyword">const</span> <span class="keyword">char</span> *line);</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> push_string(<span class="keyword">const</span> <span class="keyword">char</span> *name)</div><div class="line">{</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> name_len = <span class="built_in">strlen</span>(name) + <span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="built_in">fputs</span>(name, stdout);</div><div class="line">	<span class="built_in">putchar</span>(<span class="number">0</span>);</div><div class="line">	offset += name_len;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> push_pad (<span class="keyword">void</span>)</div><div class="line">{</div><div class="line">	<span class="keyword">while</span> (offset & <span class="number">3</span>) {</div><div class="line">		<span class="built_in">putchar</span>(<span class="number">0</span>);</div><div class="line">		offset++;</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> push_rest(<span class="keyword">const</span> <span class="keyword">char</span> *name)</div><div class="line">{</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> name_len = <span class="built_in">strlen</span>(name) + <span class="number">1</span>;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> tmp_ofs;</div><div class="line"></div><div class="line">	<span class="built_in">fputs</span>(name, stdout);</div><div class="line">	<span class="built_in">putchar</span>(<span class="number">0</span>);</div><div class="line">	offset += name_len;</div><div class="line"></div><div class="line">	tmp_ofs = name_len + <span class="number">110</span>;</div><div class="line">	<span class="keyword">while</span> (tmp_ofs & <span class="number">3</span>) {</div><div class="line">		<span class="built_in">putchar</span>(<span class="number">0</span>);</div><div class="line">		offset++;</div><div class="line">		tmp_ofs++;</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> push_hdr(<span class="keyword">const</span> <span class="keyword">char</span> *s)</div><div class="line">{</div><div class="line">	<span class="built_in">fputs</span>(s, stdout);</div><div class="line">	offset += <span class="number">110</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> cpio_trailer(<span class="keyword">void</span>)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> s[<span class="number">256</span>];</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> name[] = <span class="string">"TRAILER!!!"</span>;</div><div class="line"></div><div class="line">	<span class="built_in">sprintf</span>(s, <span class="string">"%s%08X%08X%08lX%08lX%08X%08lX"</span></div><div class="line">	       <span class="string">"%08X%08X%08X%08X%08X%08X%08X"</span>,</div><div class="line">		<span class="string">"070701"</span>,		<span class="comment">/* magic */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* ino */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* mode */</span></div><div class="line">		(<span class="keyword">long</span>) <span class="number">0</span>,		<span class="comment">/* uid */</span></div><div class="line">		(<span class="keyword">long</span>) <span class="number">0</span>,		<span class="comment">/* gid */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* nlink */</span></div><div class="line">		(<span class="keyword">long</span>) <span class="number">0</span>,		<span class="comment">/* mtime */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* filesize */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* major */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* minor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rmajor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rminor */</span></div><div class="line">		(<span class="keyword">unsigned</span>)<span class="built_in">strlen</span>(name)+<span class="number">1</span>, <span class="comment">/* namesize */</span></div><div class="line">		<span class="number">0</span>);			<span class="comment">/* chksum */</span></div><div class="line">	push_hdr(s);</div><div class="line">	push_rest(name);</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (offset % <span class="number">512</span>) {</div><div class="line">		<span class="built_in">putchar</span>(<span class="number">0</span>);</div><div class="line">		offset++;</div><div class="line">	}</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkslink(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *target,</div><div class="line">			 <span class="keyword">unsigned</span> <span class="keyword">int</span> mode, uid_t uid, gid_t gid)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> s[<span class="number">256</span>];</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">'/'</span>)</div><div class="line">		name++;</div><div class="line">	<span class="built_in">sprintf</span>(s,<span class="string">"%s%08X%08X%08lX%08lX%08X%08lX"</span></div><div class="line">	       <span class="string">"%08X%08X%08X%08X%08X%08X%08X"</span>,</div><div class="line">		<span class="string">"070701"</span>,		<span class="comment">/* magic */</span></div><div class="line">		ino++,			<span class="comment">/* ino */</span></div><div class="line">		S_IFLNK | mode,		<span class="comment">/* mode */</span></div><div class="line">		(<span class="keyword">long</span>) uid,		<span class="comment">/* uid */</span></div><div class="line">		(<span class="keyword">long</span>) gid,		<span class="comment">/* gid */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* nlink */</span></div><div class="line">		(<span class="keyword">long</span>) default_mtime,	<span class="comment">/* mtime */</span></div><div class="line">		(<span class="keyword">unsigned</span>)<span class="built_in">strlen</span>(target)+<span class="number">1</span>, <span class="comment">/* filesize */</span></div><div class="line">		<span class="number">3</span>,			<span class="comment">/* major */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* minor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rmajor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rminor */</span></div><div class="line">		(<span class="keyword">unsigned</span>)<span class="built_in">strlen</span>(name) + <span class="number">1</span>,<span class="comment">/* namesize */</span></div><div class="line">		<span class="number">0</span>);			<span class="comment">/* chksum */</span></div><div class="line">	push_hdr(s);</div><div class="line">	push_string(name);</div><div class="line">	push_pad();</div><div class="line">	push_string(target);</div><div class="line">	push_pad();</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkslink_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> name[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">char</span> target[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mode;</div><div class="line">	<span class="keyword">int</span> uid;</div><div class="line">	<span class="keyword">int</span> gid;</div><div class="line">	<span class="keyword">int</span> rc = -<span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="number">5</span> != <span class="built_in">sscanf</span>(line, <span class="string">"%"</span> str(PATH_MAX) <span class="string">"s %"</span> str(PATH_MAX) <span class="string">"s %o %d %d"</span>, name, target, &mode, &uid, &gid)) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"Unrecognized dir format '%s'"</span>, line);</div><div class="line">		<span class="keyword">goto</span> fail;</div><div class="line">	}</div><div class="line">	rc = cpio_mkslink(name, target, mode, uid, gid);</div><div class="line"> fail:</div><div class="line">	<span class="keyword">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkgeneric(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">unsigned</span> <span class="keyword">int</span> mode,</div><div class="line">		       uid_t uid, gid_t gid)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> s[<span class="number">256</span>];</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">'/'</span>)</div><div class="line">		name++;</div><div class="line">	<span class="built_in">sprintf</span>(s,<span class="string">"%s%08X%08X%08lX%08lX%08X%08lX"</span></div><div class="line">	       <span class="string">"%08X%08X%08X%08X%08X%08X%08X"</span>,</div><div class="line">		<span class="string">"070701"</span>,		<span class="comment">/* magic */</span></div><div class="line">		ino++,			<span class="comment">/* ino */</span></div><div class="line">		mode,			<span class="comment">/* mode */</span></div><div class="line">		(<span class="keyword">long</span>) uid,		<span class="comment">/* uid */</span></div><div class="line">		(<span class="keyword">long</span>) gid,		<span class="comment">/* gid */</span></div><div class="line">		<span class="number">2</span>,			<span class="comment">/* nlink */</span></div><div class="line">		(<span class="keyword">long</span>) default_mtime,	<span class="comment">/* mtime */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* filesize */</span></div><div class="line">		<span class="number">3</span>,			<span class="comment">/* major */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* minor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rmajor */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* rminor */</span></div><div class="line">		(<span class="keyword">unsigned</span>)<span class="built_in">strlen</span>(name) + <span class="number">1</span>,<span class="comment">/* namesize */</span></div><div class="line">		<span class="number">0</span>);			<span class="comment">/* chksum */</span></div><div class="line">	push_hdr(s);</div><div class="line">	push_rest(name);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">enum</span> generic_types {</div><div class="line">	GT_DIR,</div><div class="line">	GT_PIPE,</div><div class="line">	GT_SOCK</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct</span> generic_type {</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *type;</div><div class="line">	mode_t mode;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> generic_type generic_type_table[] = {</div><div class="line">	[GT_DIR] = {</div><div class="line">		.type = <span class="string">"dir"</span>,</div><div class="line">		.mode = S_IFDIR</div><div class="line">	},</div><div class="line">	[GT_PIPE] = {</div><div class="line">		.type = <span class="string">"pipe"</span>,</div><div class="line">		.mode = S_IFIFO</div><div class="line">	},</div><div class="line">	[GT_SOCK] = {</div><div class="line">		.type = <span class="string">"sock"</span>,</div><div class="line">		.mode = S_IFSOCK</div><div class="line">	}</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkgeneric_line(<span class="keyword">const</span> <span class="keyword">char</span> *line, <span class="keyword">enum</span> generic_types gt)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> name[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mode;</div><div class="line">	<span class="keyword">int</span> uid;</div><div class="line">	<span class="keyword">int</span> gid;</div><div class="line">	<span class="keyword">int</span> rc = -<span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="number">4</span> != <span class="built_in">sscanf</span>(line, <span class="string">"%"</span> str(PATH_MAX) <span class="string">"s %o %d %d"</span>, name, &mode, &uid, &gid)) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"Unrecognized %s format '%s'"</span>,</div><div class="line">			line, generic_type_table[gt].type);</div><div class="line">		<span class="keyword">goto</span> fail;</div><div class="line">	}</div><div class="line">	mode |= generic_type_table[gt].mode;</div><div class="line">	rc = cpio_mkgeneric(name, mode, uid, gid);</div><div class="line"> fail:</div><div class="line">	<span class="keyword">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkdir_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">return</span> cpio_mkgeneric_line(line, GT_DIR);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkpipe_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">return</span> cpio_mkgeneric_line(line, GT_PIPE);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mksock_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">return</span> cpio_mkgeneric_line(line, GT_SOCK);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mknod(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">unsigned</span> <span class="keyword">int</span> mode,</div><div class="line">		       uid_t uid, gid_t gid, <span class="keyword">char</span> dev_type,</div><div class="line">		       <span class="keyword">unsigned</span> <span class="keyword">int</span> maj, <span class="keyword">unsigned</span> <span class="keyword">int</span> min)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> s[<span class="number">256</span>];</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (dev_type == <span class="string">'b'</span>)</div><div class="line">		mode |= S_IFBLK;</div><div class="line">	<span class="keyword">else</span></div><div class="line">		mode |= S_IFCHR;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">'/'</span>)</div><div class="line">		name++;</div><div class="line">	<span class="built_in">sprintf</span>(s,<span class="string">"%s%08X%08X%08lX%08lX%08X%08lX"</span></div><div class="line">	       <span class="string">"%08X%08X%08X%08X%08X%08X%08X"</span>,</div><div class="line">		<span class="string">"070701"</span>,		<span class="comment">/* magic */</span></div><div class="line">		ino++,			<span class="comment">/* ino */</span></div><div class="line">		mode,			<span class="comment">/* mode */</span></div><div class="line">		(<span class="keyword">long</span>) uid,		<span class="comment">/* uid */</span></div><div class="line">		(<span class="keyword">long</span>) gid,		<span class="comment">/* gid */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* nlink */</span></div><div class="line">		(<span class="keyword">long</span>) default_mtime,	<span class="comment">/* mtime */</span></div><div class="line">		<span class="number">0</span>,			<span class="comment">/* filesize */</span></div><div class="line">		<span class="number">3</span>,			<span class="comment">/* major */</span></div><div class="line">		<span class="number">1</span>,			<span class="comment">/* minor */</span></div><div class="line">		maj,			<span class="comment">/* rmajor */</span></div><div class="line">		min,			<span class="comment">/* rminor */</span></div><div class="line">		(<span class="keyword">unsigned</span>)<span class="built_in">strlen</span>(name) + <span class="number">1</span>,<span class="comment">/* namesize */</span></div><div class="line">		<span class="number">0</span>);			<span class="comment">/* chksum */</span></div><div class="line">	push_hdr(s);</div><div class="line">	push_rest(name);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mknod_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> name[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mode;</div><div class="line">	<span class="keyword">int</span> uid;</div><div class="line">	<span class="keyword">int</span> gid;</div><div class="line">	<span class="keyword">char</span> dev_type;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> maj;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> min;</div><div class="line">	<span class="keyword">int</span> rc = -<span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="number">7</span> != <span class="built_in">sscanf</span>(line, <span class="string">"%"</span> str(PATH_MAX) <span class="string">"s %o %d %d %c %u %u"</span>,</div><div class="line">			 name, &mode, &uid, &gid, &dev_type, &maj, &min)) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"Unrecognized nod format '%s'"</span>, line);</div><div class="line">		<span class="keyword">goto</span> fail;</div><div class="line">	}</div><div class="line">	rc = cpio_mknod(name, mode, uid, gid, dev_type, maj, min);</div><div class="line"> fail:</div><div class="line">	<span class="keyword">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkfile(<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *location,</div><div class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> mode, uid_t uid, gid_t gid,</div><div class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> nlinks)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> s[<span class="number">256</span>];</div><div class="line">	<span class="keyword">char</span> *filebuf = NULL;</div><div class="line">	<span class="keyword">struct</span> stat buf;</div><div class="line">	<span class="keyword">long</span> size;</div><div class="line">	<span class="keyword">int</span> file = -<span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> retval;</div><div class="line">	<span class="keyword">int</span> rc = -<span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> namesize;</div><div class="line">	<span class="keyword">int</span> i;</div><div class="line"></div><div class="line">	mode |= S_IFREG;</div><div class="line"></div><div class="line">	file = open (location, O_RDONLY);</div><div class="line">	<span class="keyword">if</span> (file &lt; <span class="number">0</span>) {</div><div class="line">		<span class="built_in">fprintf</span> (stderr, <span class="string">"File %s could not be opened for reading\n"</span>, location);</div><div class="line">		<span class="keyword">goto</span> error;</div><div class="line">	}</div><div class="line"></div><div class="line">	retval = fstat(file, &buf);</div><div class="line">	<span class="keyword">if</span> (retval) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"File %s could not be stat()'ed\n"</span>, location);</div><div class="line">		<span class="keyword">goto</span> error;</div><div class="line">	}</div><div class="line"></div><div class="line">	filebuf = <span class="built_in">malloc</span>(buf.st_size);</div><div class="line">	<span class="keyword">if</span> (!filebuf) {</div><div class="line">		<span class="built_in">fprintf</span> (stderr, <span class="string">"out of memory\n"</span>);</div><div class="line">		<span class="keyword">goto</span> error;</div><div class="line">	}</div><div class="line"></div><div class="line">	retval = read (file, filebuf, buf.st_size);</div><div class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>) {</div><div class="line">		<span class="built_in">fprintf</span> (stderr, <span class="string">"Can not read %s file\n"</span>, location);</div><div class="line">		<span class="keyword">goto</span> error;</div><div class="line">	}</div><div class="line"></div><div class="line">	size = <span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= nlinks; i++) {</div><div class="line">		<span class="comment">/* data goes on last link */</span></div><div class="line">		<span class="keyword">if</span> (i == nlinks) size = buf.st_size;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (name[<span class="number">0</span>] == <span class="string">'/'</span>)</div><div class="line">			name++;</div><div class="line">		namesize = <span class="built_in">strlen</span>(name) + <span class="number">1</span>;</div><div class="line">		<span class="built_in">sprintf</span>(s,<span class="string">"%s%08X%08X%08lX%08lX%08X%08lX"</span></div><div class="line">		       <span class="string">"%08lX%08X%08X%08X%08X%08X%08X"</span>,</div><div class="line">			<span class="string">"070701"</span>,		<span class="comment">/* magic */</span></div><div class="line">			ino,			<span class="comment">/* ino */</span></div><div class="line">			mode,			<span class="comment">/* mode */</span></div><div class="line">			(<span class="keyword">long</span>) uid,		<span class="comment">/* uid */</span></div><div class="line">			(<span class="keyword">long</span>) gid,		<span class="comment">/* gid */</span></div><div class="line">			nlinks,			<span class="comment">/* nlink */</span></div><div class="line">			(<span class="keyword">long</span>) buf.st_mtime,	<span class="comment">/* mtime */</span></div><div class="line">			size,			<span class="comment">/* filesize */</span></div><div class="line">			<span class="number">3</span>,			<span class="comment">/* major */</span></div><div class="line">			<span class="number">1</span>,			<span class="comment">/* minor */</span></div><div class="line">			<span class="number">0</span>,			<span class="comment">/* rmajor */</span></div><div class="line">			<span class="number">0</span>,			<span class="comment">/* rminor */</span></div><div class="line">			namesize,		<span class="comment">/* namesize */</span></div><div class="line">			<span class="number">0</span>);			<span class="comment">/* chksum */</span></div><div class="line">		push_hdr(s);</div><div class="line">		push_string(name);</div><div class="line">		push_pad();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (size) {</div><div class="line">			<span class="keyword">if</span> (fwrite(filebuf, size, <span class="number">1</span>, stdout) != <span class="number">1</span>) {</div><div class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">"writing filebuf failed\n"</span>);</div><div class="line">				<span class="keyword">goto</span> error;</div><div class="line">			}</div><div class="line">			offset += size;</div><div class="line">			push_pad();</div><div class="line">		}</div><div class="line"></div><div class="line">		name += namesize;</div><div class="line">	}</div><div class="line">	ino++;</div><div class="line">	rc = <span class="number">0</span>;</div><div class="line">	</div><div class="line">error:</div><div class="line">	<span class="keyword">if</span> (filebuf) <span class="built_in">free</span>(filebuf);</div><div class="line">	<span class="keyword">if</span> (file &gt;= <span class="number">0</span>) close(file);</div><div class="line">	<span class="keyword">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">char</span> *cpio_replace_env(<span class="keyword">char</span> *new_location)</div><div class="line">{</div><div class="line">       <span class="keyword">char</span> expanded[PATH_MAX + <span class="number">1</span>];</div><div class="line">       <span class="keyword">char</span> env_var[PATH_MAX + <span class="number">1</span>];</div><div class="line">       <span class="keyword">char</span> *start;</div><div class="line">       <span class="keyword">char</span> *end;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (start = NULL; (start = <span class="built_in">strstr</span>(new_location, <span class="string">"${"</span>)); ) {</div><div class="line">               end = <span class="built_in">strchr</span>(start, <span class="string">'}'</span>);</div><div class="line">               <span class="keyword">if</span> (start &lt; end) {</div><div class="line">                       *env_var = *expanded = <span class="string">'\0'</span>;</div><div class="line">                       <span class="built_in">strncat</span>(env_var, start + <span class="number">2</span>, end - start - <span class="number">2</span>);</div><div class="line">                       <span class="built_in">strncat</span>(expanded, new_location, start - new_location);</div><div class="line">                       <span class="built_in">strncat</span>(expanded, getenv(env_var), PATH_MAX);</div><div class="line">                       <span class="built_in">strncat</span>(expanded, end + <span class="number">1</span>, PATH_MAX);</div><div class="line">                       <span class="built_in">strncpy</span>(new_location, expanded, PATH_MAX);</div><div class="line">               } <span class="keyword">else</span></div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">       }</div><div class="line"></div><div class="line">       <span class="keyword">return</span> new_location;</div><div class="line">}</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> cpio_mkfile_line(<span class="keyword">const</span> <span class="keyword">char</span> *line)</div><div class="line">{</div><div class="line">	<span class="keyword">char</span> name[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">char</span> *dname = NULL; <span class="comment">/* malloc'ed buffer for hard links */</span></div><div class="line">	<span class="keyword">char</span> location[PATH_MAX + <span class="number">1</span>];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> mode;</div><div class="line">	<span class="keyword">int</span> uid;</div><div class="line">	<span class="keyword">int</span> gid;</div><div class="line">	<span class="keyword">int</span> nlinks = <span class="number">1</span>;</div><div class="line">	<span class="keyword">int</span> end = <span class="number">0</span>, dname_len = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> rc = -<span class="number">1</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="number">5</span> &gt; <span class="built_in">sscanf</span>(line, <span class="string">"%"</span> str(PATH_MAX) <span class="string">"s %"</span> str(PATH_MAX)</div><div class="line">				<span class="string">"s %o %d %d %n"</span>,</div><div class="line">				name, location, &mode, &uid, &gid, &end)) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"Unrecognized file format '%s'"</span>, line);</div><div class="line">		<span class="keyword">goto</span> fail;</div><div class="line">	}</div><div class="line">	<span class="keyword">if</span> (end && <span class="built_in">isgraph</span>(line[end])) {</div><div class="line">		<span class="keyword">int</span> len;</div><div class="line">		<span class="keyword">int</span> nend;</div><div class="line"></div><div class="line">		dname = <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(line));</div><div class="line">		<span class="keyword">if</span> (!dname) {</div><div class="line">			<span class="built_in">fprintf</span> (stderr, <span class="string">"out of memory (%d)\n"</span>, dname_len);</div><div class="line">			<span class="keyword">goto</span> fail;</div><div class="line">		}</div><div class="line"></div><div class="line">		dname_len = <span class="built_in">strlen</span>(name) + <span class="number">1</span>;</div><div class="line">		<span class="built_in">memcpy</span>(dname, name, dname_len);</div><div class="line"></div><div class="line">		<span class="keyword">do</span> {</div><div class="line">			nend = <span class="number">0</span>;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">sscanf</span>(line + end, <span class="string">"%"</span> str(PATH_MAX) <span class="string">"s %n"</span>,</div><div class="line">					name, &nend) &lt; <span class="number">1</span>)</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			len = <span class="built_in">strlen</span>(name) + <span class="number">1</span>;</div><div class="line">			<span class="built_in">memcpy</span>(dname + dname_len, name, len);</div><div class="line">			dname_len += len;</div><div class="line">			nlinks++;</div><div class="line">			end += nend;</div><div class="line">		} <span class="keyword">while</span> (<span class="built_in">isgraph</span>(line[end]));</div><div class="line">	} <span class="keyword">else</span> {</div><div class="line">		dname = name;</div><div class="line">	}</div><div class="line">	rc = cpio_mkfile(dname, cpio_replace_env(location),</div><div class="line">	                 mode, uid, gid, nlinks);</div><div class="line"> fail:</div><div class="line">	<span class="keyword">if</span> (dname_len) <span class="built_in">free</span>(dname);</div><div class="line">	<span class="keyword">return</span> rc;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> usage(<span class="keyword">const</span> <span class="keyword">char</span> *prog)</div><div class="line">{</div><div class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">"Usage:\n"</span></div><div class="line">		<span class="string">"\t%s [-t &lt;timestamp&gt;] &lt;cpio_list&gt;\n"</span></div><div class="line">		<span class="string">"\n"</span></div><div class="line">		<span class="string">"&lt;cpio_list&gt; is a file containing newline separated entries that\n"</span></div><div class="line">		<span class="string">"describe the files to be included in the initramfs archive:\n"</span></div><div class="line">		<span class="string">"\n"</span></div><div class="line">		<span class="string">"# a comment\n"</span></div><div class="line">		<span class="string">"file &lt;name&gt; &lt;location&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt; [&lt;hard links&gt;]\n"</span></div><div class="line">		<span class="string">"dir &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;\n"</span></div><div class="line">		<span class="string">"nod &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt; &lt;dev_type&gt; &lt;maj&gt; &lt;min&gt;\n"</span></div><div class="line">		<span class="string">"slink &lt;name&gt; &lt;target&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;\n"</span></div><div class="line">		<span class="string">"pipe &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;\n"</span></div><div class="line">		<span class="string">"sock &lt;name&gt; &lt;mode&gt; &lt;uid&gt; &lt;gid&gt;\n"</span></div><div class="line">		<span class="string">"\n"</span></div><div class="line">		<span class="string">"&lt;name&gt;       name of the file/dir/nod/etc in the archive\n"</span></div><div class="line">		<span class="string">"&lt;location&gt;   location of the file in the current filesystem\n"</span></div><div class="line">		<span class="string">"             expands shell variables quoted with ${}\n"</span></div><div class="line">		<span class="string">"&lt;target&gt;     link target\n"</span></div><div class="line">		<span class="string">"&lt;mode&gt;       mode/permissions of the file\n"</span></div><div class="line">		<span class="string">"&lt;uid&gt;        user id (0=root)\n"</span></div><div class="line">		<span class="string">"&lt;gid&gt;        group id (0=root)\n"</span></div><div class="line">		<span class="string">"&lt;dev_type&gt;   device type (b=block, c=character)\n"</span></div><div class="line">		<span class="string">"&lt;maj&gt;        major number of nod\n"</span></div><div class="line">		<span class="string">"&lt;min&gt;        minor number of nod\n"</span></div><div class="line">		<span class="string">"&lt;hard links&gt; space separated list of other links to file\n"</span></div><div class="line">		<span class="string">"\n"</span></div><div class="line">		<span class="string">"example:\n"</span></div><div class="line">		<span class="string">"# A simple initramfs\n"</span></div><div class="line">		<span class="string">"dir /dev 0755 0 0\n"</span></div><div class="line">		<span class="string">"nod /dev/console 0600 0 0 c 5 1\n"</span></div><div class="line">		<span class="string">"dir /root 0700 0 0\n"</span></div><div class="line">		<span class="string">"dir /sbin 0755 0 0\n"</span></div><div class="line">		<span class="string">"file /sbin/kinit /usr/src/klibc/kinit/kinit 0755 0 0\n"</span></div><div class="line">		<span class="string">"\n"</span></div><div class="line">		<span class="string">"&lt;timestamp&gt; is time in seconds since Epoch that will be used\n"</span></div><div class="line">		<span class="string">"as mtime for symlinks, special files and directories. The default\n"</span></div><div class="line">		<span class="string">"is to use the current time for these entries.\n"</span>,</div><div class="line">		prog);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">struct</span> file_handler file_handler_table[] = {</div><div class="line">	{</div><div class="line">		.type    = <span class="string">"file"</span>,</div><div class="line">		.handler = cpio_mkfile_line,</div><div class="line">	}, {</div><div class="line">		.type    = <span class="string">"nod"</span>,</div><div class="line">		.handler = cpio_mknod_line,</div><div class="line">	}, {</div><div class="line">		.type    = <span class="string">"dir"</span>,</div><div class="line">		.handler = cpio_mkdir_line,</div><div class="line">	}, {</div><div class="line">		.type    = <span class="string">"slink"</span>,</div><div class="line">		.handler = cpio_mkslink_line,</div><div class="line">	}, {</div><div class="line">		.type    = <span class="string">"pipe"</span>,</div><div class="line">		.handler = cpio_mkpipe_line,</div><div class="line">	}, {</div><div class="line">		.type    = <span class="string">"sock"</span>,</div><div class="line">		.handler = cpio_mksock_line,</div><div class="line">	}, {</div><div class="line">		.type    = NULL,</div><div class="line">		.handler = NULL,</div><div class="line">	}</div><div class="line">};</div><div class="line"></div><div class="line"><span class="preprocessor">#<span class="keyword">define</span> LINE_SIZE (2 * PATH_MAX + 50)</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> main (<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</div><div class="line">{</div><div class="line">	FILE *cpio_list;</div><div class="line">	<span class="keyword">char</span> line[LINE_SIZE];</div><div class="line">	<span class="keyword">char</span> *args, *type;</div><div class="line">	<span class="keyword">int</span> ec = <span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> line_nr = <span class="number">0</span>;</div><div class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *filename;</div><div class="line"></div><div class="line">	default_mtime = time(NULL);</div><div class="line">	<span class="keyword">while</span> (<span class="number">1</span>) {</div><div class="line">		<span class="keyword">int</span> opt = getopt(argc, argv, <span class="string">"t:h"</span>);</div><div class="line">		<span class="keyword">char</span> *invalid;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (opt == -<span class="number">1</span>)</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">switch</span> (opt) {</div><div class="line">		<span class="keyword">case</span> <span class="string">'t'</span>:</div><div class="line">			default_mtime = strtol(optarg, &invalid, <span class="number">10</span>);</div><div class="line">			<span class="keyword">if</span> (!*optarg || *invalid) {</div><div class="line">				<span class="built_in">fprintf</span>(stderr, <span class="string">"Invalid timestamp: %s\n"</span>,</div><div class="line">						optarg);</div><div class="line">				usage(argv[<span class="number">0</span>]);</div><div class="line">				<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">			}</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> <span class="string">'h'</span>:</div><div class="line">		<span class="keyword">case</span> <span class="string">'?'</span>:</div><div class="line">			usage(argv[<span class="number">0</span>]);</div><div class="line">			<span class="built_in">exit</span>(opt == <span class="string">'h'</span> ? <span class="number">0</span> : <span class="number">1</span>);</div><div class="line">		}</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (argc - optind != <span class="number">1</span>) {</div><div class="line">		usage(argv[<span class="number">0</span>]);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	}</div><div class="line">	filename = argv[optind];</div><div class="line">	<span class="keyword">if</span> (!<span class="built_in">strcmp</span>(filename, <span class="string">"-"</span>))</div><div class="line">		cpio_list = stdin;</div><div class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!(cpio_list = fopen(filename, <span class="string">"r"</span>))) {</div><div class="line">		<span class="built_in">fprintf</span>(stderr, <span class="string">"ERROR: unable to open '%s': %s\n\n"</span>,</div><div class="line">			filename, strerror(errno));</div><div class="line">		usage(argv[<span class="number">0</span>]);</div><div class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">	}</div><div class="line"></div><div class="line">	<span class="keyword">while</span> (fgets(line, LINE_SIZE, cpio_list)) {</div><div class="line">		<span class="keyword">int</span> type_idx;</div><div class="line">		size_t slen = <span class="built_in">strlen</span>(line);</div><div class="line"></div><div class="line">		line_nr++;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="string">'#'</span> == *line) {</div><div class="line">			<span class="comment">/* comment - skip to next line */</span></div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (! (type = strtok(line, <span class="string">" \t"</span>))) {</div><div class="line">			<span class="built_in">fprintf</span>(stderr,</div><div class="line">				<span class="string">"ERROR: incorrect format, could not locate file type line %d: '%s'\n"</span>,</div><div class="line">				line_nr, line);</div><div class="line">			ec = -<span class="number">1</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="string">'\n'</span> == *type) {</div><div class="line">			<span class="comment">/* a blank line */</span></div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (slen == <span class="built_in">strlen</span>(type)) {</div><div class="line">			<span class="comment">/* must be an empty line */</span></div><div class="line">			<span class="keyword">continue</span>;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (! (args = strtok(NULL, <span class="string">"\n"</span>))) {</div><div class="line">			<span class="built_in">fprintf</span>(stderr,</div><div class="line">				<span class="string">"ERROR: incorrect format, newline required line %d: '%s'\n"</span>,</div><div class="line">				line_nr, line);</div><div class="line">			ec = -<span class="number">1</span>;</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (type_idx = <span class="number">0</span>; file_handler_table[type_idx].type; type_idx++) {</div><div class="line">			<span class="keyword">int</span> rc;</div><div class="line">			<span class="keyword">if</span> (! <span class="built_in">strcmp</span>(line, file_handler_table[type_idx].type)) {</div><div class="line">				<span class="keyword">if</span> ((rc = file_handler_table[type_idx].handler(args))) {</div><div class="line">					ec = rc;</div><div class="line">					<span class="built_in">fprintf</span>(stderr, <span class="string">" line %d\n"</span>, line_nr);</div><div class="line">				}</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			}</div><div class="line">		}</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (NULL == file_handler_table[type_idx].type) {</div><div class="line">			<span class="built_in">fprintf</span>(stderr, <span class="string">"unknown file type line %d: '%s'\n"</span>,</div><div class="line">				line_nr, line);</div><div class="line">		}</div><div class="line">	}</div><div class="line">	<span class="keyword">if</span> (ec == <span class="number">0</span>)</div><div class="line">		cpio_trailer();</div><div class="line"></div><div class="line">	<span class="built_in">exit</span>(ec);</div><div class="line">}</div></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2015/04/17/abc/" data-id="tbxap7tm5x69lw22" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/03/20/Installatin of vim plugin/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Basic/">Basic</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/D02/">D02</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Basic/" style="font-size: NaNpx;">Basic</a><a href="/tags/D02/" style="font-size: NaNpx;">D02</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/04/17/abc/">cpio Filesystem</a>
          </li>
        
          <li>
            <a href="/2015/03/20/Installatin of vim plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/03/20/uncompression under linux/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/03/20/Installation of Chrome/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/03/12/D02_20150311/">D02 hacking manual v0312</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 flyingnosky<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>